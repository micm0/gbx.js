/* GBXjs 0.5.0 - (c) Petr Pivonka & Tom - released under MIT */
var fs=require("fs");const{performance:performance}=require("perf_hooks");!function(e){"use strict";if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e.apply(null,[].map(function(e){return require(e)}));else if("function"==typeof define&&define.amd)define([],e);else{var n;(n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).GBX=e.apply(null,[].map(function(e){return n[e]}))}}(function(){var e,n,t,r,o,u,s,l,m,d,c=[],h=[],p=new TextDecoder,b={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"Stadium®",10003:"Common"};function y(e){f=this.read,e.data.constructor===Uint8Array||e.force?g(e,f):async function(){e.data=new Uint8Array(await function(e){if("undefined"!=typeof process&&"node"===process.release.name)return fs.readFileSync(e,(e,n)=>e?reject(e):resolve(n));return new Promise((n,t)=>{let a=new FileReader;a.addEventListener("loadend",e=>n(e.target.result)),a.addEventListener("error",t),a.readAsArrayBuffer(e)})}(e.data)),g(e,f)}()}function g(e,n){e.thumbnail&&(this.thumb=e.thumbnail),this.onParse=e.onParse,this.onThumb=e.onThumb,this.buffer=e.data,void 0!==this.buffer?n(this.buffer):s=1}function v(e){u=e,l=0}function T(){return r=u[l],l+=1,r}function w(e){for(o=new Uint8Array(e),i=0;i<e;i++)o[i]=T();return o}function k(){return(o=w(4))[0]|o[1]<<8|o[2]<<16|o[3]<<24}function S(){return(o=w(8))[0]|o[1]<<8|o[2]<<16|o[3]<<24|o[4]<<32|o[5]<<40|o[6]<<48|o[7]<<56}function U(e){return null==e&&(e=k()),p.decode(w(e))}function C(){return U(1)}function I(){null==m&&(m=k());var e=new Uint32Array([k()])[0];if(0==(16383&e)&&(e>>30==1||e>>30==-2)){var n=U();return h.push(n),n}if(16383!=(16383&e))return e>>30==0?null==b[e]?(s=10,e):b[e]:h.Count>(16383&e)-1?h[(16383&e)-1]:"";switch(e>>30){case 2:return"Unassigned";case 3:return"";default:s=5}}function x(){return{id:I(),collection:I(),author:I()}}function M(){return!!k()}function z(){return k().toFixed(2)}function D(){return{x:z(),y:z()}}function V(e){return"undefined"!=typeof process&&"node"===process.release.name?Buffer.from(e).toString("base64"):btoa(new Uint8Array(e).reduce(function(e,n){return e+String.fromCharCode(n)},""))}function A(e){return void 0===e?"Trackmania 1":"Trackmania"==e||e.match(/^OrbitalDev@/g)?"Trackmania®":"TMCE@nadeolabs"==e||"TMTurbo@nadeolabs"==e?"Trackmania Turbo":"ManiaPlanet"}return y.prototype.read=function(){var r=performance.now();if(d=[],c=[],l=0,s=0,m=null,u=this.buffer,"GBX"==U(3)){if((e=(o=w(2))[0]|o[1]<<8)>=3&&(C(),C(),C(),e>=4&&C(),n=k(),e>=6&&k()>0)){for(t=k(),a=0;a<t;a++){var i=4095&k(),f=k(),h=0!=(f&1<<31);c[i]={size:2147483647&f,isHeavy:h}}for(var p in c)c[p].data=w(c[p].size),delete c[p].size;if(50606080==n||603992064==n){d.type="Map",v(c[2].data),(y=T())<3&&(d.mapInfo=x(),d.mapName=U()),k(),y>=1&&(d.bronzeTime=k(),d.silverTime=k(),d.goldTime=k(),d.authorTime=k(),2==y&&T(),y>=4&&(d.cost=k(),y>=5&&(d.isMultilap=M(),6==y&&M(),y>=7&&(d.trackType=k(),y>=9&&(k(),y>=10&&(d.authorScore=k(),y>=11&&(d.editorMode=k(),d.isSimple=0!=(1&d.editorMode),d.hasGhostBlocks=0!=(2&d.editorMode),y>=12&&(M(),y>=13&&(d.nbCheckpoints=k(),d.nbLaps=k()))))))))),v(c[3].data);var b=T();d.mapInfo=x(),d.mapName=U(),d.mapNameD=d.mapName.replace(/(\$)\$|\$([a-f0-9]{2,3}|[lh]\[.*?\]|.)/gi,"$1"),6==T()&&(s=4),b>=1&&(d.locked=M(),d.password=U(),b>=2&&(d.decoration=x(),b>=3&&(d.mapOrigin=D(),b>=4&&(d.mapTarget=D(),b>=5&&(S(),S(),b>=6&&(d.mapType=U(),d.mapStyle=U(),b<=8&&M(),b>=8&&(d.lightmapCacheUID=V(w(8)),b>=9&&(d.lightmapVersion=T(),b>=11&&(d.titleUID=I()))))))))),d.game=A(d.titleUID),v(c[5].data),d.xml=U(),b>5&&(v(c[8].data),k(),d.authorVersion=k(),d.authorLogin=U(),d.authorNickname=U(),d.authorZone=U(),d.authorExtraInfo=U())}else if(50933760==n||604495872==n||604237824==n){d.type="Replay",v(c[0].data),chunk000Version=k(),chunk000Version>=2&&(d.mapInfo=x(),d.time=k(),d.driverNickname=U(),chunk000Version>=6&&(d.driverLogin=U(),chunk000Version>=8&&(T(),d.titleUID=I()))),d.game=A(d.titleUID),v(c[1].data),d.xml=U();try{v(c[2].data);var y=k();d.authorVersion=k(),d.authorLogin=U(),d.authorNickname=U(),d.authorZone=U(),d.authorExtraInfo=U()}catch(e){}}else s=3}}else s=2;if(void 0!==this.onParse&&this.onParse.length>0){var g=performance.now();this.onParse(d,s,c,n,g-r)}this.thumb&&"Map"==d.type&&(v(c[7].data),0!=k()&&(d.thumbnailSize=k(),a,U("<Thumbnail.jpg>".length),0==d.thumbnailSize?d.thumbnail=null:d.thumbnail=w(d.thumbnailSize),U("</Thumbnail.jpg>".length),U("<Comments>".length),d.comments=U(),U("</Comments>".length)),"base64"==this.thumb&&(d.thumbnail=V(d.thumbnail)));if(void 0!==this.onThumb&&this.onThumb.length>0){g=performance.now();this.onThumb(d.thumbnail,d.thumbnailSize,c,g-r)}},y});